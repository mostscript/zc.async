<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Quickstart with virtualenv &mdash; zc.async v1.5.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '',
          VERSION:     '1.5.0',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: ''
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/interface.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="contents" title="Global table of contents" href="contents.html" />
    <link rel="index" title="Global index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="zc.async v1.5.0 documentation" href="index.html" />
    <link rel="next" title="Quickstart with Grok" href="QUICKSTART_2_GROK.html" />
    <link rel="prev" title="zc.async" href="index.html" />
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="QUICKSTART_2_GROK.html" title="Quickstart with Grok"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="zc.async"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">zc.async v1.5.0 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  
  <div class="section" id="id1">
<span id="quickstart-with-virtualenv"></span><h1 id="id1"><span id="quickstart-with-virtualenv"></span>Quickstart with <tt class="docutils literal"><span class="pre">virtualenv</span></tt><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="prerequisites">
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installation">
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>To start, install <a class="reference external" href="http://pypi.python.org/pypi/virtualenv"><tt class="docutils literal"><span class="pre">virtualenv</span></tt></a> and create a virtual environment for our
experiments.</p>
<div class="sidebar">
<p class="first sidebar-title"><tt class="docutils literal"><span class="pre">virtualenv</span></tt> and <tt class="docutils literal"><span class="pre">zc.buildout</span></tt></p>
<p class="last">I prefer <a class="reference external" href="http://pypi.python.org/pypi/zc.buildout"><tt class="docutils literal"><span class="pre">zc.buildout</span></tt></a> for production deployments, but <a class="reference external" href="http://pypi.python.org/pypi/virtualenv"><tt class="docutils literal"><span class="pre">virtualenv</span></tt></a> is
very nice for quick experimentation.  The other quick-start uses
<a class="reference external" href="http://pypi.python.org/pypi/zc.buildout"><tt class="docutils literal"><span class="pre">zc.buildout</span></tt></a>.</p>
</div>
<pre>$ easy_install virtualenv
$ virtualenv quickstart</pre>
<p>Install <a class="reference external" href="http://pypi.python.org/pypi/zc.async"><tt class="docutils literal"><span class="pre">zc.async</span></tt></a> in the virtual environment.</p>
<pre>$ cd quickstart/
$ ./bin/easy_install zc.async</pre>
</div>
<div class="section" id="dependencies">
<h3 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Example Dependencies</p>
<p>Here&#8217;s an example listing of the site-packages brought in by a run of this
quick-start.</p>
<pre>$ ls lib/python2.5/site-packages/
Twisted-8.1.0-py2.5-macosx-10.5-i386.egg
ZConfig-2.5.1-py2.5.egg
ZODB3-3.8.1b5-py2.5-macosx-10.5-i386.egg
easy-install.pth
pytz-2008c-py2.5.egg
rwproperty-1.0-py2.5.egg
setuptools-0.6c8-py2.5.egg
setuptools.pth
uuid-1.30-py2.5.egg
zc.async-1.4.0-py2.5.egg
zc.dict-1.2.1-py2.5.egg
zc.queue-1.1-py2.5.egg
zc.twist-1.3-py2.5-macosx-10.5-i386.egg
zdaemon-2.0.2-py2.5.egg
zope.bforest-1.2-py2.5.egg
zope.component-3.4.0-py2.5.egg
zope.deferredimport-3.4.0-py2.5.egg
zope.deprecation-3.4.0-py2.5.egg
zope.event-3.4.0-py2.5.egg
zope.i18nmessageid-3.4.3-py2.5-macosx-10.5-i386.egg
zope.interface-3.4.1-py2.5-macosx-10.5-i386.egg
zope.minmax-1.1.0-py2.5.egg
zope.proxy-3.4.1-py2.5-macosx-10.5-i386.egg
zope.testing-3.6.0-py2.5.egg</pre>
</div>
<p>This installed several packages.</p>
<ul class="simple">
<li>the <a class="reference external" href="http://pypi.python.org/pypi/ZODB3">ZODB</a>, an object database from the Zope project;</li>
<li><a class="reference external" href="http://pypi.python.org/pypi/Twisted">Twisted</a>, a framework for networked applications;</li>
<li>the component architecture from the Zope project;</li>
<li>and a few smaller packages.</li>
</ul>
<p>All of these, and zc.async, are distributed under BSD-like licenses such as
LGPL and <a class="reference external" href="http://en.wikipedia.org/wiki/Zope_Public_License">ZPL</a>.</p>
</div>
<div class="section" id="zeo-server">
<h3 id="zeo-server">ZEO Server<a class="headerlink" href="#zeo-server" title="Permalink to this headline">¶</a></h3>
<p>zc.async relies on a distributed ZODB technology called ZEO (&#8220;Zope Enterprise
Objects&#8221;) to distribute work. ZEO has a central database server to which client
processes connect.</p>
<p>Let&#8217;s start the ZEO Server:</p>
<pre>$ ./bin/runzeo -a 9999 -f test.fs &amp;</pre>
<p>That starts a database server, accessible on port 9999 of your local machine,
saving the data in the test.fs file.</p>
</div>
</div>
<div class="section" id="starting-async">
<h2 id="starting-async">Starting <tt class="docutils literal"><span class="pre">zc.async</span></tt><a class="headerlink" href="#starting-async" title="Permalink to this headline">¶</a></h2>
<div class="section" id="a-client">
<h3 id="a-client">A Client<a class="headerlink" href="#a-client" title="Permalink to this headline">¶</a></h3>
<p>Now let&#8217;s start a Python with a client connection to the database server.</p>
<p>Start up <tt class="docutils literal"><span class="pre">bin/python</span></tt> (not your system python, but the one in virtualenv&#8217;s
<tt class="docutils literal"><span class="pre">quickstart/bin</span></tt>):</p>
<pre>$ ./bin/python</pre>
<p>This will be our single client process.</p>
<p>You might have many, each connecting to the main database server, and each able
to perform and/or request <tt class="docutils literal"><span class="pre">zc.async</span></tt> jobs.</p>
</div>
<div class="section" id="database-connection">
<h3 id="database-connection">Database Connection<a class="headerlink" href="#database-connection" title="Permalink to this headline">¶</a></h3>
<p>Connect to the database.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="start-async">
<h3 id="start-async">Start <tt class="docutils literal"><span class="pre">zc.async</span></tt><a class="headerlink" href="#start-async" title="Permalink to this headline">¶</a></h3>
<div class="section" id="basics">
<h4 id="basics">Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h4>
<p>Now we do some basic configuration.  This first bit installs some default
adapters.  You might not ever have to worry too much about them.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">zc.async.configure</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="policy">
<h4 id="policy">Policy<a class="headerlink" href="#policy" title="Permalink to this headline">¶</a></h4>
<p>This second part is policy, and if you ever put zc.async in production, you&#8217;ll
want to understand what&#8217;s going on here.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
</pre></div>
<p>Now the system has a <tt class="docutils literal"><span class="pre">dispatcher</span></tt> polling for jobs every second.  As we&#8217;ll
see below, a <tt class="docutils literal"><span class="pre">dispatcher</span></tt> polls for jobs in one or more queues, to assign
them to worker threads.</p>
</div>
</div>
</div>
<div class="section" id="using-async">
<h2 id="using-async">Using <tt class="docutils literal"><span class="pre">zc.async</span></tt><a class="headerlink" href="#using-async" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-queue">
<h3 id="the-queue">The Queue<a class="headerlink" href="#the-queue" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">start</span></tt> function also installed a queue.  To get zc.async to do work, you
put a job in a queue, and commit the transaction.</p>
<p>First, let&#8217;s get the queue that we have installed.  We need to open a
connection to the database.  Then we get the queue.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">zc.async.interfaces</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IQueue</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="a-job">
<h3 id="a-job">A Job<a class="headerlink" href="#a-job" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">A Silly Example</p>
<p>This is a silly example. Imagine instead that this was some really
long-running job. Maybe you have lots of these jobs coming in, and you need
to have many machines to claim jobs and perform them, so that you can
scale. Maybe this job divides itself up into parallel or serial jobs, and
this parent job isn&#8217;t done until all the children jobs run to completion.</p>
<p class="last">Or maybe this is a silly example.</p>
</div>
<p>Let&#8217;s put a job in our queue.  This silly example will return the current time.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</pre></div>
<p>It&#8217;s not done yet.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">j</span><span class="o">.</span><span class="n">result</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">j</span><span class="o">.</span><span class="n">status</span>
<span class="go">u&#39;pending-status&#39;</span>
</pre></div>
</div>
<div class="section" id="a-transaction">
<h3 id="a-transaction">A Transaction<a class="headerlink" href="#a-transaction" title="Permalink to this headline">¶</a></h3>
<p>We have to commit the transaction for the dispatcher to see the job.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">transaction</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="a-result">
<h3 id="a-result">A Result<a class="headerlink" href="#a-result" title="Permalink to this headline">¶</a></h3>
<p>Now wait a second and then try this.  &#8220;transaction.begin&#8221; will sync up our
database with database changes made elsewhere.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">j</span><span class="o">.</span><span class="n">result</span>
<span class="go">1216179006.856108</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">j</span><span class="o">.</span><span class="n">status</span>
<span class="go">u&#39;completed-status&#39;</span>
</pre></div>
</div>
<div class="section" id="another-job-and-closures">
<h3 id="another-job-and-closures">Another Job (And Closures)<a class="headerlink" href="#another-job-and-closures" title="Permalink to this headline">¶</a></h3>
<p>You can also make closures.  The Job class accepts arguments similarly to
the Python 2.5 <tt class="xref docutils literal"><span class="pre">functools.partial()</span></tt>: <tt class="docutils literal"><span class="pre">Job(func,</span> <span class="pre">\*args,</span>
<span class="pre">\*\*keywords)</span></tt>. This instantiates a new callable (a Job instance) with
partial application of the given arguments and keywords.  You can then
pass the job instance to the
<tt class="xref docutils literal"><span class="pre">put()</span></tt> method.</p>
<p>Generating RSA keys is actually a reasonable real-world use case for
something like this.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
    <span class="p">[</span><span class="s">&#39;openssl&#39;</span><span class="p">,</span> <span class="s">&#39;genrsa&#39;</span><span class="p">,</span> <span class="s">&#39;-out&#39;</span><span class="p">,</span>
     <span class="s">&#39;key.pem&#39;</span><span class="p">,</span> <span class="s">&#39;1024&#39;</span><span class="p">]))</span>
<span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
<p>We need to begin the transaction to see the result...</p>
<div class="highlight"><pre><span class="n">j</span><span class="o">.</span><span class="n">result</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">j</span><span class="o">.</span><span class="n">result</span>
</pre></div>
<p>...which in this case is simply <tt class="docutils literal"><span class="pre">0</span></tt>, indicating a successful UNIX
process.</p>
<div class="highlight"><pre><span class="mf">0</span>
</pre></div>
<p>We can open the file to show the result.</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&#39;cat&#39;</span><span class="p">,</span> <span class="s">&#39;key.pem&#39;</span><span class="p">])</span>
</pre></div>
<p>This will show you the key, which should look something like this:</p>
<pre>-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQCYAZW+HjDGJhRHnUlZZWqhrGOxU2K/RhssmcMs0JLnWI2cWmZ+
...
CEcz6ZbO8zm4AEGI/dqLicZh3bhunhflAovW6WxbNKLENQ==
-----END RSA PRIVATE KEY-----
0</pre>
</div>
</div>
<div class="section" id="running-your-own-code">
<h2 id="running-your-own-code">Running Your Own Code<a class="headerlink" href="#running-your-own-code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="a-monte-carlo-simulation">
<h3 id="a-monte-carlo-simulation">A Monte Carlo Simulation<a class="headerlink" href="#a-monte-carlo-simulation" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Another Silly Example</p>
<p class="last">Monte Carlo simulations are generally better suited to other tasks in
real-world use; pi is typically calculated by <a class="reference external" href="http://en.wikipedia.org/wiki/Computing_π">far more sophisticated
means</a>.</p>
</div>
<p>We&#8217;ve now seen some simple examples from the standard library.  But how do you
get your own work done?</p>
<p>Let&#8217;s say we want to implement an old chestnut of a problem: use a <a class="reference external" href="http://en.wikipedia.org/wiki/Monte_Carlo_method">Monte
Carlo simulation</a> (that is, &#8220;throwing darts and analyzing the results&#8221;) to
<a class="reference external" href="http://math.fullerton.edu/mathews/n2003/MonteCarloPiMod.html">calculate pi</a>.  This will use <tt class="docutils literal"><span class="pre">zc.async</span></tt> much like the map-reduce approach
of <a class="reference external" href="http://hadoop.apache.org/core/">Hadoop</a>: we will want to distribute the work of running the simulation to
multiple machines so the result can be done faster.</p>
</div>
<div class="section" id="picklable-callables-and-arguments">
<h3 id="picklable-callables-and-arguments">Picklable Callables and Arguments<a class="headerlink" href="#picklable-callables-and-arguments" title="Permalink to this headline">¶</a></h3>
<p>You want a job to have a reference to your own callable, so the job will get
the work you define performed.</p>
<p>This reference, of the job to your callable, will need to be persisted in the
database.</p>
<div class="sidebar">
<p class="first sidebar-title">ZODB Persistence Rules</p>
<p>We don&#8217;t need these now.  But if you are really curious about ZODB
persistence rules, here&#8217;s a start.</p>
<ul class="simple">
<li>Anything pickleable can be persisted.  Module global functions can be
pickled (by name), for instance, and will come in handy for our examples.</li>
<li>Custom classes should typically inherit from persistent.Persistent.
Instances of persistent.Persistent subclasses are each stored as a single
record in the database, and references to them are handled efficiently.</li>
<li>Subclasses of persistent.Persistent produce instances that recognize when
their <em>direct</em> attributes have been written, and inform the database that
they are dirty, for the next committed transaction.  Standard,
non-persistent-aware mutables such as lists, sets and dicts do <em>not</em> know
when they have been changed, and are best avoided, or at least not
mutated. A variety of persistent-aware replacements for these types are
available.</li>
<li>Use the transaction module to commit and abort transactions in the ZODB.</li>
</ul>
<p>More advanced concerns include the following.</p>
<ul class="simple">
<li>An optimistic implementation of <a class="reference external" href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> in the ZODB means that you should be
careful reading (not writing) one persistent.Persistent instance (record)
and writing another persistent.Persistent instance with a value that
depends on the first, read value within a transaction.</li>
<li>Concurrent transactions can produce write conflict errors.  Transactions
are often automatically retried in <tt class="docutils literal"><span class="pre">zc.async</span></tt> and other ZODB-based systems if
conflict errors are encountered.  If this is not desired for a given
<tt class="docutils literal"><span class="pre">zc.async</span></tt> job, it should be given a <tt class="docutils literal"><span class="pre">zc.async.job.NeverRetry</span></tt> retry
policy, as discussed elsewhere in this documentation.</li>
</ul>
<p class="last">For ZODB documentation see <a class="reference external" href="http://www.zope.org/Wikis/ZODB/guide/zodb.html">http://www.zope.org/Wikis/ZODB/guide/zodb.html</a></p>
</div>
<p>Because zc.async uses the ZODB for its persistence mechanism, the ZODB&#8217;s
persistence rules are in effect.</p>
<p>Luckily, these are fairly simple.</p>
<p>For now, we&#8217;ll stay as simple as it gets: if you use <em>module global functions</em>
and <em>immutables</em>, and share software across instances, you&#8217;ll be fine.</p>
<p>ZODB allows a lot more, if you&#8217;re willing to follow a few more rules, but that
one rule will get us moving for this quick-start.</p>
</div>
<div class="section" id="process-uuids">
<h3 id="process-uuids">Process UUIDs<a class="headerlink" href="#process-uuids" title="Permalink to this headline">¶</a></h3>
<p>Exit the Python interpreter (control-D).  Look around in the directory
(<tt class="docutils literal"><span class="pre">ls</span></tt>): you should see a few database files, the key.pem you created, and a
new file: <tt class="docutils literal"><span class="pre">uuid.txt</span></tt>.  It should look something like this:</p>
<pre>$ cat uuid.txt
afd1e0d0-52e1-11dd-879b-0017f2c49bdd
------------------------------------------------------------------------
The value above (and this file) is created and used by the zc.async
package. It is intended to uniquely identify this software instance when
it is used to start a zc.async dispatcher.  This allows multiple
dispatchers, each in its own software instance, to connect to a single
database to do work.

In order to decide where to look for this file (or to create it, if
necessary), the module looks in ``os.environ['ZC_ASYNC_UUID']`` for a
file name.

If you are using zdaemon (http://pypi.python.org/pypi/zdaemon) to
daemonize your process, you can set this in a zdaemon environment section
of your zdaemon.conf. Supervisor (http://supervisord.org/) also provides
this functionality. Other similar tools probably do as well.

If the ``ZC_ASYNC_UUID`` is not found in the environment, it will use
``os.path.join(os.getgwd(), 'uuid.txt')`` as the file name.

To get a new identifier for this software instance, delete this file,
restart Python, and import zc.async.instanceuuid.  This file will be
recreated with a new value.</pre>
<p>That text is intended to be self-explanatory, so hopefully it made sense to
you.  We&#8217;ll handle these UUIDs more explicitly in a moment.</p>
</div>
<div class="section" id="make-a-file">
<h3 id="make-a-file">Make a File<a class="headerlink" href="#make-a-file" title="Permalink to this headline">¶</a></h3>
<p>Make a new Python file.  Let&#8217;s call it <tt class="docutils literal"><span class="pre">pi.py</span></tt>.
Save this file in <tt class="docutils literal"><span class="pre">lib/python2.5/site-packages/</span></tt>.</p>
<p>Use the following for the file content.</p>
<div class="sidebar">
<p class="first sidebar-title">Code Walkthrough</p>
<p>This code walkthrough focuses on the elements needed to use <tt class="docutils literal"><span class="pre">zc.async</span></tt>,
rather than the calculation of pi.  Numerous explanations of this Monte
Carlo simulation to calculate pi are on the internet.  I liked <a class="reference external" href="http://math.fullerton.edu/mathews/n2003/MonteCarloPiMod.html">this one</a>.</p>
<p>We begin with some imports.</p>
<p>The <tt class="docutils literal"><span class="pre">generate_sample</span></tt> code will be run on multiple processes to produce
samples for our Monte Carlo function simulation.  It is ignorant of
<tt class="docutils literal"><span class="pre">zc.async</span></tt>.</p>
<p>Once the samples are all done, we&#8217;ll reduce the results with
<tt class="docutils literal"><span class="pre">process_samples</span></tt>.  It will return an approximation of pi, with
accuracy strongly influenced by the total size of the aggregated samples,
assuming even distribution of the random numbers.  As you&#8217;ll see
soon, we&#8217;ll be using a <tt class="docutils literal"><span class="pre">zc.async</span></tt> convenience function for
<tt class="xref docutils literal"><span class="pre">parallel()</span></tt> jobs that gives all of the completed
jobs that have been running in parallel to this, the postprocessing
call. Therefore, <tt class="docutils literal"><span class="pre">process_samples</span></tt> gets the <tt class="docutils literal"><span class="pre">result</span></tt> of
<tt class="docutils literal"><span class="pre">generate_sample</span></tt> off of each job. Other than that, this function
is ignorant of <tt class="docutils literal"><span class="pre">zc.async</span></tt>.</p>
<p class="last">The last code block should look similar to our previous example of starting
up a dispatcher, except this one uses the main, installed Twisted reactor,
rather than a threaded instance.  It creates the database, configures
zc.async, and starts the reactor.  We use a short poll_interval so we can
have a perceptually snappy response in this quick start.</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="kn">import</span> <span class="nn">twisted.internet.reactor</span>

<span class="kn">import</span> <span class="nn">zc.async.configure</span>

<span class="k">def</span> <span class="nf">generate_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">100000</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">process_samples</span><span class="p">(</span><span class="o">*</span><span class="n">sample_jobs</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span> 
    <span class="n">size</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sample_jobs</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="n">size</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
        <span class="n">db</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">twisted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="our-first-monte-carlo-experiment">
<h3 id="our-first-monte-carlo-experiment">Our First Monte Carlo Experiment<a class="headerlink" href="#our-first-monte-carlo-experiment" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;ll need the ZEO server running.  If you&#8217;ve gone through this file from the
start, it should still be running.  If not, use this:</p>
<pre>$ ./bin/runzeo -a 9999 -f test.fs &amp;</pre>
<p>Now, for our first experiment with the Monte Carlo simulation, we&#8217;ll start a
single worker process.</p>
<p>Enter this in the terminal:</p>
<pre>$ ./bin/python lib/python2.5/site-packages/pi.py &amp;</pre>
<p>That will start our worker process.  Now let&#8217;s start an interpreter.</p>
<pre>$ ./bin/python</pre>
<p>Now get a database and a connection, as we&#8217;ve seen before.  We&#8217;ll also set up
the base zc.async configuration.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">zc.async.configure</span>
<span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
</pre></div>
<p>We don&#8217;t have any adapters installed, so <tt class="docutils literal"><span class="pre">zc.async.interfaces.IQueue(conn)</span></tt>
won&#8217;t work.  This will though, and still looks pretty good:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">zc.async.queue</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getDefaultQueue</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
<p>Now we can start some jobs in <tt class="xref docutils literal"><span class="pre">parallel()</span></tt>.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pi</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">zc.async.job</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">postprocess</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">process_samples</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">transaction</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
<p>Wait a few seconds.  If the result is empty (None), begin the transaction again
and check the result again.  Eventually, these next two lines should give you a
result: an approximation of pi.</p>
<div class="highlight"><pre><span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">j</span><span class="o">.</span><span class="n">result</span>
</pre></div>
<p>For one run, I got <tt class="docutils literal"><span class="pre">3.1386666666666665</span></tt>.  Cool.</p>
</div>
<div class="section" id="closures">
<h3 id="closures">Closures<a class="headerlink" href="#closures" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;ve already seen Jobs used as closures in the openssl example.  You can also
use them to pass a different <tt class="docutils literal"><span class="pre">size</span></tt> argument to <tt class="docutils literal"><span class="pre">generate_sample</span></tt>.</p>
<p>Let&#8217;s try it.</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="mf">1000000</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1000000</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">postprocess</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">process_samples</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
<p>Wait a bit, again.  Retry these two lines until you get a result.  It should
be well under a minute on most machines.</p>
<div class="highlight"><pre><span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">j</span><span class="o">.</span><span class="n">result</span>
</pre></div>
<p>My run got <tt class="docutils literal"><span class="pre">3.1434359999999999</span></tt>.  Cool.</p>
</div>
<div class="section" id="configuration">
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Unfortunately, the parallel runs we&#8217;ve done so far would actually make the
calculation go slower than if we did it in a single function call!  That&#8217;s
because we ran it in a single Python worker process, and the overhead of
threads just makes the jobs a bit less efficient.  Threads help for some uses
of <tt class="docutils literal"><span class="pre">zc.async</span></tt>, but not this one.</p>
<p>Let&#8217;s assume you are running these experiments on a machine with two processor
cores.  We should actually start two worker processes then, one for each core.
We&#8217;ll need to make sure each worker process has its own OID.</p>
<p>Moreover, we need to configure each process to only take one
<tt class="docutils literal"><span class="pre">generate_sample</span></tt> job at a time.  Let&#8217;s adjust our code to do that.</p>
<div class="section" id="agents">
<h4 id="agents">Agents<a class="headerlink" href="#agents" title="Permalink to this headline">¶</a></h4>
<p>A worker process regularly polls the database for new jobs.  The software
component that polls is called a <tt class="docutils literal"><span class="pre">dispatcher</span></tt>. Dispatchers look in the
database to ask their personal <tt class="docutils literal"><span class="pre">agent</span></tt> (or agents) to determine what
they should get their threads to do.  Think of the <tt class="docutils literal"><span class="pre">agent</span></tt> as a
&#8220;<a class="reference external" href="http://en.wikipedia.org/wiki/Talent_agent">talent agent</a>&#8221; or a &#8220;booking agent&#8221; for the process.</p>
<p>By default, using the zc.async.configure helpers, each dispatcher is given a
single agent that will choose the first job in the queue, and that wants to run
no more than three jobs at a time.</p>
<p>For our Monte Carlo job, we&#8217;ll give each process an additional agent. The
new agent will only accept up to one instance of a <tt class="docutils literal"><span class="pre">generate_sample</span></tt>
job at a time.</p>
<p>We will also reconfigure the existing agent to accept up to three of
anything <em>except</em> <tt class="docutils literal"><span class="pre">generate_sample</span></tt>.</p>
<p>We&#8217;ll do that in our file.  Here&#8217;s the revised version.  The only changes
are the imports, the three new functions, and setting up
<tt class="docutils literal"><span class="pre">install_agent</span></tt> in the <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__':</span></tt> block.</p>
<div class="sidebar">
<p class="first sidebar-title">Code Walkthrough for Changes</p>
<p>We import three new modules from <tt class="docutils literal"><span class="pre">zc.async</span></tt>, :mod:zc.async.queue,
:mod:zc.async.instanceuuid, and :mod:zc.async.agent.  The
<tt class="xref docutils literal"><span class="pre">IAgent</span></tt>
implementation (<tt class="xref docutils literal"><span class="pre">zc.async.agent.Agent</span></tt>) uses a function called a
<tt class="xref docutils literal"><span class="pre">chooser</span></tt> to determine its
policy for choosing agents.  We define two chooser functions, one for
each agent: <tt class="docutils literal"><span class="pre">choose_generate_sample</span></tt> and <tt class="docutils literal"><span class="pre">choose_another</span></tt>.  Then
we have a function <tt class="docutils literal"><span class="pre">install_agent</span></tt> to set up the old agent to use
<tt class="docutils literal"><span class="pre">choose_another</span></tt>, and create a new agent of <tt class="docutils literal"><span class="pre">size=1</span></tt> with the
<tt class="docutils literal"><span class="pre">choose_generate_sample</span></tt> chooser.  We make sure this function is
installed to run when the Twisted reactor starts. That&#8217;s it.</p>
<p>It&#8217;s important to note that the references to these functions are
persistent, and by name.  If you change the location or name of these
functions, you will need to keep the old names and locations around,
at least for long enough to switch your agents to use the new names.
This is a general pattern for module globals&#8211;functions and
classes&#8211;to which the ZODB has direct references or instances.</p>
<p>We could have accomplished the same basic policy changes with several
different agent configurations. For instance, we could have written a
chooser that looked through its agents&#8217;s current jobs to verify that
it did not have another <tt class="docutils literal"><span class="pre">generate_sample</span></tt>.</p>
<p class="last">The only trick to this kind of agent configuration is that you always
want to have at least some catch-all dispatchers who are willing to do
just about any jobs (what our <tt class="docutils literal"><span class="pre">choose_another</span></tt> choose accomplishes).
This supports jobs that the <tt class="docutils literal"><span class="pre">zc.async</span></tt> system sometimes needs to run for
exceptional circumstances.</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="kn">import</span> <span class="nn">transaction</span>
<span class="kn">import</span> <span class="nn">twisted.internet.reactor</span>

<span class="kn">import</span> <span class="nn">zc.async.configure</span>
<span class="kn">import</span> <span class="nn">zc.async.queue</span>
<span class="kn">import</span> <span class="nn">zc.async.instanceuuid</span>
<span class="kn">import</span> <span class="nn">zc.async.agent</span>

<span class="k">def</span> <span class="nf">generate_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">100000</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">process_samples</span><span class="p">(</span><span class="o">*</span><span class="n">sample_jobs</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span> 
    <span class="n">size</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sample_jobs</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">choose_generate_sample</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;generate_sample&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choose_another</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;generate_sample&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">install_agent</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getDefaultQueue</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">dispatchers</span><span class="p">[</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">instanceuuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">install_agent</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;generate_sample&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="p">:</span>
                <span class="n">agent</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">chooser</span> <span class="o">=</span> <span class="n">choose_another</span>
                <span class="n">dispatcher</span><span class="p">[</span><span class="s">&#39;generate_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
                    <span class="n">choose_generate_sample</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
        <span class="n">db</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">twisted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callWhenRunning</span><span class="p">(</span><span class="n">install_agent</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
    <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="demonstration">
<h3 id="demonstration">Demonstration<a class="headerlink" href="#demonstration" title="Permalink to this headline">¶</a></h3>
<p>Now let&#8217;s start up our workers, and see how they work.  We&#8217;re going to
have two workers now, and they will each need separate UUIDs.  A really
simple approach will be to make two separate working directories for the
two worker processes.  (We also could use the environmental variable,
<tt class="docutils literal"><span class="pre">ZC_ASYNC_UUID</span></tt>, described in the <a class="reference internal" href="#process-uuids">Process UUIDs</a> section above.)</p>
<pre>$ mkdir worker1
$ mv uuid.txt worker1
$ cd worker1
$ ../bin/python ../lib/python2.5/site-packages/pi.py &amp;
$ cd ..
$ mkdir worker2
$ cd worker2
$ ../bin/python ../lib/python2.5/site-packages/pi.py &amp;</pre>
<p>Now we&#8217;ll start the Python process in which we will test our code.  We&#8217;ll move
to the main directory, but as long as we don&#8217;t start another worker, it doesn&#8217;t
really matter.</p>
<pre>$ cd ..
$ ./bin/python</pre>
<p>And now, our test.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">zc.async.configure</span>
<span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">pi</span>
<span class="kn">import</span> <span class="nn">zc.async.job</span>
<span class="kn">import</span> <span class="nn">zc.async.queue</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getDefaultQueue</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="mf">5000000</span><span class="p">),</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">5000000</span><span class="p">),</span>
    <span class="n">postprocess</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">process_samples</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">transaction</span>
<span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
<p>Wait a few seconds and then try these lines.</p>
<div class="highlight"><pre><span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">j</span><span class="o">.</span><span class="n">result</span>
</pre></div>
<p>If the result is empty (None), repeat those two lines again (thatæ is, begin
the transaction again and check the result again).  Eventually, these lines
should give you a result: an approximation of pi.</p>
<p>Just to prove to ourselves that we saved some time, let&#8217;s do a comparison test:
the same number of samples, but not in parallel.</p>
<div class="highlight"><pre><span class="n">j2</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">pi</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">,</span> <span class="mf">10000000</span><span class="p">),</span>
    <span class="n">postprocess</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">process_samples</span><span class="p">))</span>
<span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">j2</span><span class="o">.</span><span class="n">result</span>
</pre></div>
<p>Once both jobs are complete, compare their run-time.</p>
<div class="highlight"><pre><span class="n">j</span><span class="o">.</span><span class="n">active_end</span> <span class="o">-</span> <span class="n">j</span><span class="o">.</span><span class="n">active_start</span>
<span class="n">j2</span><span class="o">.</span><span class="n">active_end</span> <span class="o">-</span> <span class="n">j2</span><span class="o">.</span><span class="n">active_start</span>
</pre></div>
<p>On my machine, even in this simple, short example, running in parallel
with a job per processor/core took 7.8 seconds, while running all in one
process took 13.4 seconds.</p>
</div>
</div>
<div class="section" id="monitoring">
<h2 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<p>Soon, you may want to be able to monitor or introspect what&#8217;s going on in your
zc.async work.  The package provides several tools to do that.  We&#8217;ll take a
look at a few here.</p>
<p>We will be turning on a monitor port.  This port should be protected behind a
firewall, like your ZEO ports.</p>
<p>If you like the functionality that we describe here but would prefer to expose
it in a different manner, note that most of the Python functions in
<tt class="docutils literal"><span class="pre">monitor.py</span></tt> and <tt class="docutils literal"><span class="pre">monitordb.py</span></tt> power the zc.async commands in the monitor
port, and can be used without the monitor itself.</p>
<p>To enable the monitoring port, we need to install some extra dependencies for
zc.async: &#8220;[monitor]&#8221;.  Exit the Python interpreter an make sure you are in the
top &#8220;quickstart&#8221; directory, and then enter this command:</p>
<blockquote>
$ ./bin/easy_install zc.async[monitor]</blockquote>
<p>If you take a glance at the output, you&#8217;ll see we&#8217;ve only added a few
dependencies: <tt class="docutils literal"><span class="pre">simplejson</span></tt>, <tt class="docutils literal"><span class="pre">zc.ngi</span></tt>, and <tt class="docutils literal"><span class="pre">zc.monitor</span></tt>.</p>
<p>Now let&#8217;s turn on the port and the zc.async commands.</p>
<p>At the top of the <tt class="docutils literal"><span class="pre">pi.py</span></tt> file, add some imports:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zope.component</span>
<span class="kn">import</span> <span class="nn">zc.monitor</span>
<span class="kn">import</span> <span class="nn">zc.monitor.interfaces</span>
<span class="kn">import</span> <span class="nn">zc.async.monitor</span>
<span class="kn">import</span> <span class="nn">zc.async.monitordb</span>
</pre></div>
<p>Then down in the <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__':</span></tt> block, add these lines at the
top.</p>
<div class="highlight"><pre><span class="n">monitor_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MONITOR_PORT&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">monitor_port</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">quit</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">help</span><span class="p">,</span>
              <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">async</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">monitordb</span><span class="o">.</span><span class="n">asyncdb</span><span class="p">):</span>
        <span class="n">zope</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">provideUtility</span><span class="p">(</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IMonitorPlugin</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">monitor_port</span><span class="p">))</span>
</pre></div>
<p>The file should look like this now.</p>
<table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">ZEO.ClientStorage</span>
<span class="kn">import</span> <span class="nn">ZODB</span>
<span class="kn">import</span> <span class="nn">transaction</span>
<span class="kn">import</span> <span class="nn">twisted.internet.reactor</span>
<span class="kn">import</span> <span class="nn">zc.monitor</span>
<span class="kn">import</span> <span class="nn">zc.monitor.interfaces</span>
<span class="kn">import</span> <span class="nn">zope.component</span>

<span class="kn">import</span> <span class="nn">zc.async.configure</span>
<span class="kn">import</span> <span class="nn">zc.async.queue</span>
<span class="kn">import</span> <span class="nn">zc.async.instanceuuid</span>
<span class="kn">import</span> <span class="nn">zc.async.agent</span>
<span class="kn">import</span> <span class="nn">zc.async.monitor</span>
<span class="kn">import</span> <span class="nn">zc.async.monitordb</span>

<span class="k">def</span> <span class="nf">generate_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">100000</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">process_samples</span><span class="p">(</span><span class="o">*</span><span class="n">sample_jobs</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mf">0</span> 
    <span class="n">size</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sample_jobs</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">choose_generate_sample</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;generate_sample&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choose_another</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;generate_sample&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">install_agent</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getDefaultQueue</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">dispatchers</span><span class="p">[</span><span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">instanceuuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">install_agent</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;generate_sample&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="p">:</span>
                <span class="n">agent</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">chooser</span> <span class="o">=</span> <span class="n">choose_another</span>
                <span class="n">dispatcher</span><span class="p">[</span><span class="s">&#39;generate_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
                    <span class="n">choose_generate_sample</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">monitor_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MONITOR_PORT&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">monitor_port</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">quit</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">help</span><span class="p">,</span>
                  <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">async</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">monitordb</span><span class="o">.</span><span class="n">asyncdb</span><span class="p">):</span>
            <span class="n">zope</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">provideUtility</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IMonitorPlugin</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">zc</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">monitor_port</span><span class="p">))</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">ZEO</span><span class="o">.</span><span class="n">ClientStorage</span><span class="o">.</span><span class="n">ClientStorage</span><span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mf">9999</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
    <span class="n">zc</span><span class="o">.</span><span class="n">async</span><span class="o">.</span><span class="n">configure</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
        <span class="n">db</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">twisted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callWhenRunning</span><span class="p">(</span><span class="n">install_agent</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
    <span class="n">twisted</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table><p>Now stop and restart your two worker instances, this time providing two
different ports in the environment for each worker.  Here&#8217;s one way to do it.
First we&#8217;ll shut down the previous instances.  If you used the lines above to
start them before, type <tt class="docutils literal"><span class="pre">fg</span></tt> and RETURN, and then CTRL-C to stop worker 2;
and then do the same thing (<tt class="docutils literal"><span class="pre">fg</span></tt> and RETURN, and then CTRL-C) to stop worker
1.</p>
<pre>$ cd worker1
$ MONITOR_PORT=9991 ../bin/python ../lib/python2.5/site-packages/pi.py &amp;
$ cd ../worker2
$ MONITOR_PORT=9992 ../bin/python ../lib/python2.5/site-packages/pi.py &amp;</pre>
<p>Now you can open connections to these two ports, 9991 and 9992, and query the
worker (using the <tt class="docutils literal"><span class="pre">async</span></tt> command, primarily) and the state of zc.async in
the database itself (the <tt class="docutils literal"><span class="pre">asyncdb</span></tt> command).</p>
<p>The easiest way to experiment with this is using telnet.  Try this.</p>
<pre>$ telnet 127.0.0.1 9991</pre>
<p>You should see something like this:</p>
<pre>Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.</pre>
<p>Now you can experiment with commands.  Try this (followed by a RETURN):</p>
<div class="highlight"><pre><span class="n">help</span>
</pre></div>
<p>You should see something like this:</p>
<pre>Supported commands:
  async -- Monitor zc.async activity in this process.
  asyncdb -- Monitor and introspect zc.async activity in the database.
  help -- Get help about server commands
  interactive -- Turn on monitor's interactive mode
  quit -- Quit the monitor
Connection closed by foreign host.
$</pre>
<p>Hm, it dumped us straight back to the shell!  <tt class="docutils literal"><span class="pre">zc.monitor</span></tt> behaves that way
tp be friendly to automated monitoring processes using the port.  We can use
the <tt class="docutils literal"><span class="pre">interactive</span></tt> command to make things a bit more pleasant for ourselves.</p>
<p>Reuse the telnet command shown above, or maybe connect to 9992 (<tt class="docutils literal"><span class="pre">telnet</span>
<span class="pre">127.0.0.1</span> <span class="pre">9992</span></tt>) to see that you can.  This time, type the <tt class="docutils literal"><span class="pre">interactive</span></tt>
command first.  You should see this reply:</p>
<pre>Interactive mode on.  Use "quit" To exit.</pre>
<p>Now experiment!  Try some of these commands to see what you get.</p>
<pre>help async

async help

async help status

async status

async help poll

async poll

async UUID

async utcnow

help asyncdb

asyncdb help

asyncdb help UUIDs

asyncdb UUIDs

asyncdb lastcompleted

asyncdb count completed

asyncdb count completed uuid:THIS</pre>
<p>That last command shows how many jobs this worker has completed for as long as
the database has records, which by default means between seven and eight days.
The help for <tt class="docutils literal"><span class="pre">asyncdb</span> <span class="pre">count</span></tt>, which is available from <tt class="docutils literal"><span class="pre">asyncdb</span> <span class="pre">help</span> <span class="pre">count</span></tt>,
is not short, but tells you the many options available.</p>
<p>When you are done, use the <tt class="docutils literal"><span class="pre">quit</span></tt> command to exit the telnet connection to
the monitor port.</p>
<p>Another important tool is logging.  The <tt class="docutils literal"><span class="pre">zc.async.event</span></tt> logger gets
important events&#8211;pay special attention to critical events!  <tt class="docutils literal"><span class="pre">zc.async.trace</span></tt>
lets you follow along with every detail, if so desired.</p>
<p>These monitoring and introspection tools, combined with logging, provide
powerful tools to keep track of your zc.async work.</p>
</div>
<div class="section" id="other-configuration">
<h2 id="other-configuration">Other Configuration<a class="headerlink" href="#other-configuration" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;re at the end of this quickstart.  To close, here&#8217;s a quick survey of some
other configuration opportunities available that we haven&#8217;t seen here.</p>
<ul class="simple">
<li>Callbacks are a very important per-job configuration.  You can add them to
a job, to be run unconditionally, conditionally if the result is an
instance of a <tt class="docutils literal"><span class="pre">twisted.python.failure.Failure</span></tt>, or conditionally if
the result is not a <tt class="docutils literal"><span class="pre">Failure</span></tt>.  See
<tt class="xref docutils literal"><span class="pre">addCallback()</span></tt>,
<tt class="xref docutils literal"><span class="pre">addCallbacks()</span></tt>, and
<tt class="xref docutils literal"><span class="pre">callbacks</span></tt></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unlike Twisted callbacks, all callbacks for the same job get the same
result; if you would like to chain results, the callbacks themselves
are Jobs, so attach a callback to your callback.</p>
</div>
<ul class="simple">
<li>You can request that a job <tt class="xref docutils literal"><span class="pre">begin_after</span></tt>
a given timezone-aware datetime.  If not given, this defaults to now, for the
purposes of calculating the effective
<tt class="xref docutils literal"><span class="pre">begin_by</span></tt> datetime, described below.</li>
<li>You can specify that a job should <tt class="xref docutils literal"><span class="pre">begin_by</span></tt>
a given duration (datetime.timedelta) <em>after</em> the jobs&#8217;s
<tt class="xref docutils literal"><span class="pre">begin_after</span></tt> value.  When the queue
:gets
ready to offer the job for an agent to choose, if the effective
<tt class="docutils literal"><span class="pre">begin_by</span></tt> value has passed, the queue will instead offer a call to
the job&#8217;s
<tt class="xref docutils literal"><span class="pre">fail()</span></tt> method.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no built-in way to stop a running job, short of stopping the
process.  This can be approximated by use in your job of
<tt class="xref docutils literal"><span class="pre">getLiveAnnotation()</span></tt> to poll for stop requests; or the
brave can write some C to use <a class="reference external" href="http://docs.python.org/api/threads.html">PyThreadState_SetAsyncExc</a>.</p>
</div>
<ul class="simple">
<li>You can set up quotas for certain arbitrary quota names that you define.
This is a limit: no more than the given quota can run at once, total,
across all workers.  This can let you decrease the chance of conflict
errors for long-running jobs that write to the same data structures.  See
<tt class="xref docutils literal"><span class="pre">quotas</span></tt>,
<tt class="xref docutils literal"><span class="pre">IQuotas</span></tt>, and
<tt class="xref docutils literal"><span class="pre">quota_names</span></tt>.</li>
<li>Retry policies determine how jobs should be retried if they raise an
uncaught exception while running, if their commit raises an error, or if
they are interrupted.  They can be configured per job, or as defaults for
callback and non-callback jobs.  See
<tt class="xref docutils literal"><span class="pre">IRetryPolicy</span></tt>,
<tt class="xref docutils literal"><span class="pre">retry_policy_factory</span></tt>,
<tt class="xref docutils literal"><span class="pre">getRetryPolicy()</span></tt>; the default retry policies
<tt class="xref docutils literal"><span class="pre">RetryCommonFourTimes</span></tt>,
<tt class="xref docutils literal"><span class="pre">RetryCommonForever</span></tt> and
<tt class="xref docutils literal"><span class="pre">NeverRetry</span></tt>; and the <tt class="docutils literal"><span class="pre">retry_policy_factory</span></tt> argument
to <tt class="xref docutils literal"><span class="pre">addCallback()</span></tt>,
<tt class="xref docutils literal"><span class="pre">addCallbacks()</span></tt>, and
<tt class="xref docutils literal"><span class="pre">put()</span></tt>.</li>
<li>The <tt class="xref docutils literal"><span class="pre">failure_log_level</span></tt> determines at what
level Failure results for a given job should be logged.  This is usually
logging.ERROR, and logging.CRITICAL for callbacks.  This can be set directly
on the job, or applied via the <tt class="docutils literal"><span class="pre">failure_log_level</span></tt> argument to
<tt class="xref docutils literal"><span class="pre">addCallback()</span></tt>,
<tt class="xref docutils literal"><span class="pre">addCallbacks()</span></tt>, and
<tt class="xref docutils literal"><span class="pre">put()</span></tt>.</li>
<li>Custom job subclasses can take advantage of
<tt class="xref docutils literal"><span class="pre">setUp()</span></tt> and
<tt class="xref docutils literal"><span class="pre">tearDown()</span></tt> hooks to set up and tear down
state.  An example is the Zope 3-specific <tt class="xref docutils literal"><span class="pre">Job</span></tt>.</li>
<li>A custom queue might support broadcasting jobs across dispatchers, or
targeting specific dispatchers.  These features may be developed for <tt class="docutils literal"><span class="pre">zc.async</span></tt>
itself at a later date.</li>
</ul>
<p>There are many other topics to discuss&#8211;testing, debugging, and Zope 3
integration, for instance&#8211;but this is a quick start, so we&#8217;ll end here.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><img class="logo" src="_static/zc_async.png" alt="Logo"/></p>
            <h3>Table Of Contents</h3>
            <ul>
<li><a class="reference external" href="">Quickstart with <tt class="docutils literal"><span class="pre">virtualenv</span></tt></a><ul>
<li><a class="reference external" href="#prerequisites">Prerequisites</a><ul>
<li><a class="reference external" href="#installation">Installation</a></li>
<li><a class="reference external" href="#dependencies">Dependencies</a></li>
<li><a class="reference external" href="#zeo-server">ZEO Server</a></li>
</ul>
</li>
<li><a class="reference external" href="#starting-async">Starting <tt class="docutils literal"><span class="pre">zc.async</span></tt></a><ul>
<li><a class="reference external" href="#a-client">A Client</a></li>
<li><a class="reference external" href="#database-connection">Database Connection</a></li>
<li><a class="reference external" href="#start-async">Start <tt class="docutils literal"><span class="pre">zc.async</span></tt></a><ul>
<li><a class="reference external" href="#basics">Basics</a></li>
<li><a class="reference external" href="#policy">Policy</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference external" href="#using-async">Using <tt class="docutils literal"><span class="pre">zc.async</span></tt></a><ul>
<li><a class="reference external" href="#the-queue">The Queue</a></li>
<li><a class="reference external" href="#a-job">A Job</a></li>
<li><a class="reference external" href="#a-transaction">A Transaction</a></li>
<li><a class="reference external" href="#a-result">A Result</a></li>
<li><a class="reference external" href="#another-job-and-closures">Another Job (And Closures)</a></li>
</ul>
</li>
<li><a class="reference external" href="#running-your-own-code">Running Your Own Code</a><ul>
<li><a class="reference external" href="#a-monte-carlo-simulation">A Monte Carlo Simulation</a></li>
<li><a class="reference external" href="#picklable-callables-and-arguments">Picklable Callables and Arguments</a></li>
<li><a class="reference external" href="#process-uuids">Process UUIDs</a></li>
<li><a class="reference external" href="#make-a-file">Make a File</a></li>
<li><a class="reference external" href="#our-first-monte-carlo-experiment">Our First Monte Carlo Experiment</a></li>
<li><a class="reference external" href="#closures">Closures</a></li>
<li><a class="reference external" href="#configuration">Configuration</a><ul>
<li><a class="reference external" href="#agents">Agents</a></li>
</ul>
</li>
<li><a class="reference external" href="#demonstration">Demonstration</a></li>
</ul>
</li>
<li><a class="reference external" href="#monitoring">Monitoring</a></li>
<li><a class="reference external" href="#other-configuration">Other Configuration</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="index.html" title="previous chapter"><tt class="docutils literal"><span class="pre">zc.async</span></tt></a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="QUICKSTART_2_GROK.html" title="next chapter">Quickstart with Grok</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/QUICKSTART_1_VIRTUALENV.txt">Show Source</a></li>
            </ul>
            <h3>Quick search</h3>
            <form class="search" action="search.html" method="get">
              <input type="text" name="q" size="18" /> <input type="submit" value="Go" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="QUICKSTART_2_GROK.html" title="Quickstart with Grok"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="zc.async"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">zc.async v1.5.0 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2008, Gary Poster.
      Last updated on Sep 21, 2008.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>